---
title: "Modelagem de distribui√ß√£o de esp√©cies"
subtitle: "Uma introdu√ß√£o com exemplo no R"  
author: 
  - "Mar√≠lia Melo Favalesso"
role: Product Manager, Data Science Communication 
company: '@RStudio'
date: 31-10-2020
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "assets/sydney-fonts.css", "assets/sydney.css"]
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true
      scroll: false
---
background-image: url(https://www.mmfava.com/marilia.png)
background-size: 300px
background-position: 90% 5%


```{css, echo=FALSE}
pre {
  max-height: 600px;
  overflow-y: auto;
}

pre[class] {
  max-height: 600px;
}
```

```{css, echo = F}
h2 { color: brown; }
```

```{r xaringan-themer, echo=FALSE}
library(xaringanthemer)
style_xaringan(title_slide_text_color = "black", header_color = "#000000", link_color = "#339999", inverse_background_color = "#339999", title_slide_background_position = "center")
```

### Mar√≠lia Melo Favalesso 
**Forma√ß√£o**
- T√©cnica ambiental (CEEP, 2009)
- Bi√≥loga (UFPR, 2014) 
- Mestre em Ci√™ncias Ambientais (UNIOESTE, 2018) 
- Doutoranda em Ecologia (UBA - Argentina, atual)

**Projetos**
- [**GECD** - Grupo de Estudos em Ci√™ncia de Dados](https://github.com/gecdfoz/GECD)
- [**Soma dos quadrados**](https://linktr.ee/somaquadrados)
- [**Grupo de Estudos em Modelagem de nicho e distribui√ß√£o de esp√©cies**](https://linktr.ee/niche_group)

**Contatos**

- ‚úâÔ∏è [mariliabioufpr@gmail.com](mariliabioufpr@gmail.com)
- üåé [www.mmfava.com](www.mmfava.com)
- ü•ö [Twitter: @mmfbee](https://twitter.com/mmfbee)
- üíª [Github: mmfava](https://github.com/mmfava)

---
class: clear
background-image: url(figuras/Slide6.PNG)
background-size: 500px

## O que √© um modelo?

---
class: clear
background-image: url(figuras/Slide7.PNG)
background-size: 600px

## O que √© um modelo?

---
class: clear
background-image: url(figuras/Slide8.PNG)
background-size: 1000px

## Modelos de distribui√ß√£o de esp√©cies

---
class: clear
background-image: url(figuras/Slide9.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide10.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide11.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide12.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide13.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide14.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide15.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide16.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide17.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide18.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide19.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide20.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide21.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide22.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide23.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide24.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide25.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide26.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide27.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide28.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide29.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide30.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide31.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide32.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide33.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide34.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide35.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide36.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide37.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide38.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide39.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide40.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide41.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide42.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide43.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide44.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide45.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide46.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide47.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide48.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide49.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide50.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide51.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide52.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide53.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide54.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide55.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide56.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide57.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide58.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide59.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide60.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide61.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide62.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide63.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide64.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide65.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide66.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide67.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide68.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/raster.gif)
background-size: 500px

## Raster
---
class: clear
background-image: url(figuras/Slide70.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide71.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide72.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide73.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide74.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide75.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide76.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide77.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide78.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide79.PNG)
background-size: 1000px

---
class: clear
background-image: url(figuras/Slide80.PNG)
background-size: 1000px

---
## Modelagem de distribui√ß√£o de esp√©cies com o R
### Exemplo com *Trigona spinipses* na Am√©rica do Sul

### Pacotes:
```{r eval=FALSE, message=FALSE, warning=FALSE, include=TRUE}
## Instalar o pacote ENTML
devtools::install_github("andrefaa/ENMTML")  

## Carregar os pacotes
install.packages(maptools) # pacote para abrir mapas diretamente no R
install.packages(raster) # para trabalhar com rasters
install.packages(dismo) # fun√ß√£o gbif - download de ocorr√™ncias de esp√©cies. 
install.packages(tidyverse) # trabalhar com as planilhas
install.packages(ENMTML) # pacote para modelagem de nicho
install.packages(leaflet) # pacote para mapas interativos - usaremos nos resultados 
```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### Dados de ocorr√™ncia do GBIF
- Vamos baixar dados de ocorr√™ncia de *T. spinipes* do [database GBIF](https://www.gbif.org/). 

```{r message=FALSE, warning=FALSE, include=TRUE}
# - Vamos usar a fun√ß√£o "gbif()" para fazer o download dos dados.
pontos = dismo::gbif('Trigona', # g√™nero da esp√©cie
              species = "Trigona spinipes", # nome completo da esp√©cie
              sp = TRUE, # Retornar como um SpatialPointsDataFrame?
              removeZeros = TRUE, # Remover linhas com dados de latitude e/ou logitude faltantes
              download = TRUE) # Para realizar o dowload dos registros

# - Colocar o nome "data" na guia de valores (que s√£o as datas de amostragem).
names(pontos) = "data"
```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### Salvar os dados de ocorr√™ncia para utilizar com o pacote ENMTML

- O arquivo precisa ser salvo em .TXT (separado por tabula√ß√£o)! 
- Precisamos apenas de tr√™s colunas em nossa tabela:
  - 1o nome da esp√©cie
  - 2o longitude
  - 3o latitude
  
<div style="width: 1050px; height: 320px; white-space: nowrap; overflow-x: scroll; overflow-y: scroll; 
border: 0; padding: 0px; display: inline-block;">
```{r message=FALSE, warning=FALSE, include=TRUE}
library(tidyverse)

# Primeiro vamos gerar um objeto com o endere√ßo do nosso diret√≥rio de trabalho:
d_ex = file.path('C:/Users/mmfav/Dropbox/nichemod')
d_ex

# Extrair as informa√ß√µes dos pontos para uma tabela:
tabela = as.data.frame(pontos)

tabela = as.data.frame(pontos) %>% # transformar os dados em data.frame
  select('lon', 'lat') %>% # selecionar apenas long e lat
  add_column('species' = c(rep('Trigona spinipes', length(tabela$lon))),  # Incluir uma coluna com nome da sp ...
             .before = 'lon') # ... antes de coluna "lat".

# Mudar o nome das colunas para facilitar incluir na fun√ß√£o depois 
names(tabela)[2:3] = c("x", "y")

# Salvar os pontos de ocorr√™ncia como .txt
# - criar uma pasta para os pontos no diret√≥rio chamada "occ":
dir.create(paste0(d_ex, '/occ')) 
# - salvar os pontos de ocorr√™ncia em um arquivo chamado "occ.txt"
utils::write.table(tabela, file.path(d_ex, 'occ/occ.txt'), sep = '\t', row.names = FALSE)
```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### Dados de ocorr√™ncia do GBIF

```{r}
knitr::kable(x = head(pontos), format = "html")
```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### √Årea de proje√ß√£o do modelo

- Pol√≠gono do mapamundi
```{r message=FALSE, warning=FALSE, include=TRUE}
library(maptools)
data("wrld_simpl")
```

- Recortando o mapa para uma extens√£o mais pr√≥xima dos pontos de ocorr√™ncia (background).

1 - Olhar a sa√≠da de 'pontos' e ver a dimens√£o geogr√°fica dele
```{r}
pontos
```

2 - Salvar a extens√£o em um objeto chamado "ext". 
```{r}
ext = c(-85, -34.81973, -40, 0) # colocar um pouquinho mais amplo que os pontos
```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### √Årea de proje√ß√£o do modelo

3 - Recortar o mapa mundi para a extens√£o selecionada. 
```{r message=FALSE, warning=FALSE, include=TRUE}
map = raster::crop(wrld_simpl, ext)
```


---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### Background
<div style="width: 1000px; height: 400px; white-space: nowrap; overflow-x: scroll; overflow-y: scroll; 
border: 0; padding: 0px; display: inline-block;">
```{r}
plot(map, # nosso limite territorial - America do sul
     axes = T, # Pedir para incluir os eixos das coordenadas
     lwd = 1.8, # Grossura da linha do mapa
     col = "#CCFF99", # colorir os pa√≠ses de verde
     bg = "#CCFFFF") # cor do background da imagem em azul


# Plotar o nome dos pa√≠ses no mapa
text(map$LON, map$LAT, map$NAME, cex = 0.7, font = 2)

# Os pontos de ocorr√™ncia da nossa esp√©cie
points(pontos, # chamar o poligono de pontos
       pch = 20, # estilo dos pontos de ocorr√™ncia 
       col = 'red', # na cor vermelha
       cex = 1.5) # tamanho de 1.5

# Incluir legenda com o nome da esp√©cie
legend('bottomright', # do lado inferior-direito
       pch = 20, # mesmo estilo dos pontos que antes
       legend = c(as.expression(bquote(italic("Trigona spinipes")))), # Nome da sp em it√°lico
       col = 'red', # Cor do ponto em preto
       bg = 'white', # Cor do background em branco
       bty = 0, # Tipo de caixa ao redor da legenda
       cex = 1) # Tamanho da legenda
```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### Dados biogeoclim√°ticos
- Chamar os dados para o R com a fun√ß√£o `getData()`. 
- Vamos usar os dados da plataforma [wordclim](https://www.worldclim.org/).

```{r}
# diret√≥rio de trabalho
setwd('C:/Users/mmfav/Dropbox/nichemod')

# download data
r = raster::getData("worldclim", # banco de dados
            var = "bio", # var. biogeoclim√°ticas
            res = 10) # resolu√ß√£o = 10m
```

- Recortar os rasters pela extens√£o da Am√©rica do sul
```{r}
rr = raster::crop(raster::mask(r, map), map)
```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### Dados biogeoclim√°ticos

- Visualizar as vari√°veis biogeoclim√°ticas
```{r fig.width=7}
plot(rr)
```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### Dados biogeoclim√°ticos

- Salvando os dados bioclim√°ticos em um diret√≥rio pr√≥prio
```{r message=FALSE, warning=FALSE, include=TRUE}
# Criar um diret√≥rio chamado 'env':
dir.create(paste0(d_ex, '/env')) 

# Para salvar cada um dos rasters individualmente no reposit√≥rio:
for(i in names(rr)){ # para cada raster em 'rr'...
  raster::writeRaster(rr[[i]], paste0(file.path(d_ex, 'env'), "/", i, '.tif'), overwrite = T)
}
```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### Modelando a distribui√ß√£o com o pacote ENMTML

- Criar uma pasta/diret√≥rio para salvar os resultados do(s) modelo(s)
```{r eval=FALSE, message=FALSE, warning=FALSE, include=TRUE}
dir.create(paste0(d_ex, '/resultados')) 
```

- Vamos criar objetos com os endere√ßos dos diret√≥rios. Vamos usar os objetos na fun√ß√£o `ENMTML()`.
```{r}
# endere√ßo das vari√°veis clim√°ticas
d_env = file.path("C:/Users/mmfav/Dropbox/nichemod/env") 

# endere√ßo dos pontos de ocorr√™ncia
d_occ = "C:/Users/mmfav/Dropbox/nichemod/occ/occ.txt" 

```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### Modelando a distribui√ß√£o com o pacote ENMTML

<div style="width: 1100px; height: 400px; white-space: nowrap; overflow-x: scroll; overflow-y: scroll; 
border: 0; padding: 0px; display: inline-block;">
```{r}
ENMTML::ENMTML(
  pred_dir = d_env, # Endere√ßo para o diret√≥rio das vari√°veis
  proj_dir = NULL, # Quando trabalhamos com proje√ß√µes - diferentes locais no espa√ßo ou tempo
  # result_dir = res, # Pasta para salvar as sa√≠das/resultados 
  occ_file = d_occ, # Pasta onde est√£o nossos pontos de ocorr√™ncia
  sp = 'species', # coluna que cont√™m o nome das esp√©cies 
  x = 'x', # coluna que corresponde a longitude
  y = 'y', # coluna que corresponde a latitude
  min_occ = 10, # N√∫mero minimo de ocorr√™ncias para cada esp√©cie
  thin_occ = NULL, # Inserimos os m√©todos de filtragem de ocorr√™ncias dados redundantes 
  eval_occ = NULL, # Tabela com dados de ocorr√™ncia para valida√ß√£o dos dados 
  colin_var = c(method='PEARSON', threshold='0.7'), # Onde inserimos os m√©todos para evitar a colinearidade entre os dados 
  imp_var = FALSE, # Calcula a import√¢ncia das vari√°veis em curvas de resposta 
  sp_accessible_area = NULL, # M√©todo de restri√ß√£o de √°rea acess√≠vel para as esp√©cies 
  pseudoabs_method = c(method = 'RND'), # M√©todo de sele√ß√£o de pseudo-aus√™ncias aleat√≥rio
  pres_abs_ratio = 1, # Raz√£o presen√ßa-aus√™ncia (valores entre 0 e 1)
  part=c(method= 'KFOLD', folds='10'), # M√©todo de parti√ß√£o para valida√ß√£o do modelo.
  save_part = FALSE, # Save partitioned data?
  save_final = TRUE, # Salvar o modelo final em .tif (?)
  algorithm = c('BIO', 'MAH'), # algoritmos de modelagem
  thr = c(type='MAX_TSS'), # Para binarizar o mapa, qual m√©todo utilizar?
  msdm = NULL, # M√©todos de restri√ß√£o no modelo para pr√≥ximo das ocorr√™ncias conhecidas 
  ensemble = c(method='PCA'), # Qual m√©todo ensemble, ou de combina√ß√£o, realizar entre os diferentes algoritmos? 
  extrapolation = FALSE, # Se TRUE, a fun√ß√£o calcular√° a extrapola√ß√£o com base na an√°lise de paridade orientada para
                         # a mobilidade (MOP) para as condi√ß√µes atuais
  cores = 1 # Defina o n√∫mero de n√∫cleos de CPU para executar procedimentos de modelagem em paralelo (padr√£o 1).
)
```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### Visualiza√ß√£o dos resultados

- Vamos plotar os resultados usando o pacote "leaflet" 

<div style="width: 1100px; height: 400px; white-space: nowrap; overflow-x: scroll; overflow-y: scroll; 
border: 0; padding: 0px; display: inline-block;">
```{r message=FALSE, warning=FALSE, include=TRUE}
library(tidyverse)
library(leaflet)
library(raster)
# Abrir o resultado em objeto chamado 'res'
res = paste0(d_ex, '/Result/Ensemble/PCA/Trigona_spinipes.tif') %>% raster()

# Fazer uma palheta de cores variando de verde at√© vermelho; para a legenda de 'suitability'. 
pal = colorNumeric(c("#003300", "#006633", "#009300", "#FFFFCC",
                     "#FF9900", "#FF6600", "#FF3300"), values(res),
                   na.color = "transparent")

# Plotar em mapa interativo com LEAFLET
map = leaflet(pontos) %>% # Usaremos a fun√ß√£o 'leaflet' para produzir os mapas e j√° chamaremos os pontos de occ.
  addTiles() %>% # add um mapa de fundo
  addRasterImage(res, # adicionar o raster 'res' (com nossos resultados)
                 col = pal, opacity = 0.5, group = "Suitability") %>% # com cor = pal, transpar√™ncia de 50% e nome suitability
  addLegend(pal = pal, values = values(res), title = "Suitability", group = "Suitability") %>% # add legenda para raster
  
  addLayersControl(overlayGroups = c("Suitability"), # Incluir op√ß√£o de ligar e desligar o raster
                   options = layersControlOptions(collapsed = FALSE)) %>%
  addCircleMarkers(radius = 1, col = "black") %>% # adicionar os pontos de ocorr√™ncia como circulos
  addScaleBar() # Adicionar uma barra de escala

```

---
## Modelagem de distribui√ß√£o de esp√©cies com o R

### Visualiza√ß√£o dos resultados

- Vamos plotar os resultados usando o pacote "leaflet".
```{r}
map
```

---
class: center, middle

# Agradecimentos

### [R-Ladies BH](https://rladiesbh.com.br/) üíô
### [Grupo de Estudos "Niche Group"](https://linktr.ee/niche_group) üíõ

<img src="https://media1.tenor.com/images/ceadcc4af571518e125e7964e43bb714/tenor.gif?itemid=5459333" style="width: 20%;">

---
class: center, middle

# Acessar essa apresenta√ß√£o em
## www.mmfava.com


